name: Deploy to Staging

on:
  push:
    branches:
      - develop

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          ref: develop
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'
      
      # Deploy Backend Staging
      - name: Deploy Backend Staging
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            set -e
            echo "ğŸš€ Deploying Backend Staging..."
            cd /opt/schooliat/repo
            echo "ğŸ“¥ Pulling latest code from develop branch..."
            git fetch origin develop
            git checkout develop
            git reset --hard origin/develop
            git clean -fd
            echo "ğŸ“¦ Installing dependencies..."
            cd Backend
            npm ci --production
            echo "ğŸ”§ Generating Prisma client..."
            npm run prisma:generate
            echo "ğŸ—„ï¸ Running database migrations..."
            export DATABASE_URL="${{ secrets.STAGING_DATABASE_URL }}"
            npm run prisma:migrate:deploy
            echo "ğŸ”„ Restarting PM2 process..."
            pm2 restart schooliat-backend-staging --update-env
            echo "âœ… Backend Staging deployment complete!"
      
      # Deploy Dashboard Staging
      - name: Deploy Dashboard Staging
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            set -e
            echo "ğŸš€ Deploying Dashboard Staging..."
            cd /opt/schooliat/repo
            echo "ğŸ“¥ Ensuring latest code from develop branch..."
            git fetch origin develop
            git checkout develop
            cd dashboard
            echo "ğŸ“¦ Installing dependencies..."
            npm ci --production
            echo "ğŸ—ï¸ Building dashboard..."
            npm run build
            echo "ğŸ”„ Restarting PM2 process..."
            pm2 restart schooliat-dashboard-staging --update-env
            echo "âœ… Dashboard Staging deployment complete!"
