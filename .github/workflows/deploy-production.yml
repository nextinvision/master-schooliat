name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:  # Allow manual trigger

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          ref: main
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'
      
      # Deploy Backend Production
      - name: Deploy Backend Production
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: 22
          timeout: 60s
          command_timeout: 15m
          debug: true
          script: |
            set -e
            echo "Deploying Backend Production..."
            cd /opt/schooliat/repo
            echo "Pulling latest code from main branch..."
            git fetch origin main
            git checkout main
            git reset --hard origin/main
            git clean -fd
            echo "Installing dependencies in repo (for migrations)..."
            cd Backend
            npm ci
            echo "Generating Prisma client..."
            npm run prisma:generate
            echo "Creating database backup..."
            mkdir -p /opt/schooliat/shared/backups
            pg_dump -U schooliat_user schooliat_production > /opt/schooliat/shared/backups/pre-migration-$(date +%Y%m%d-%H%M%S).sql || echo "WARNING: Backup failed, continuing..."
            echo "Running database migrations..."
            export DATABASE_URL="${{ secrets.PRODUCTION_DATABASE_URL }}"
            npm run prisma:migrate:deploy
            echo "Copying code to deployment directory..."
            mkdir -p /opt/schooliat/backend/production/current
            rsync -av --exclude 'node_modules' --exclude '.git' --exclude 'prisma/migrations' /opt/schooliat/repo/Backend/ /opt/schooliat/backend/production/current/
            echo "Installing dependencies in deployment directory (including devDependencies)..."
            cd /opt/schooliat/backend/production/current
            npm ci
            echo "Generating Prisma client in deployment directory..."
            npm run prisma:generate
            echo "Restarting PM2 process..."
            pm2 restart schooliat-backend-production --update-env
            echo "Backend Production deployment complete!"
      
      # Deploy Dashboard Production
      - name: Deploy Dashboard Production
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: 22
          timeout: 60s
          command_timeout: 15m
          debug: true
          script: |
            set -e
            echo "Deploying Dashboard Production..."
            cd /opt/schooliat/repo
            echo "Ensuring latest code from main branch..."
            git fetch origin main
            git checkout main
            cd dashboard
            echo "Installing dependencies (including devDependencies for build)..."
            npm ci
            echo "Loading production environment variables for build..."
            cp /opt/schooliat/dashboard/production/shared/.env .env.production
            echo "Building dashboard with production API URL..."
            NODE_ENV=production npm run build
            echo "Copying build to production directory..."
            rm -rf /opt/schooliat/dashboard/production/.next
            cp -r .next /opt/schooliat/dashboard/production/
            cp -r public /opt/schooliat/dashboard/production/ 2>/dev/null || true
            cp package.json /opt/schooliat/dashboard/production/
            echo "Restarting PM2 process..."
            pm2 restart schooliat-dashboard-production --update-env
            echo "Dashboard Production deployment complete!"
      
      # Deploy Landing
      - name: Deploy Landing
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: 22
          timeout: 60s
          command_timeout: 15m
          debug: true
          script: |
            set -e
            echo "Deploying Landing Page..."
            cd /opt/schooliat/repo
            echo "Ensuring latest code from main branch..."
            git fetch origin main
            git checkout main
            cd landing
            echo "Installing dependencies (including devDependencies for build)..."
            npm ci
            echo "Loading production environment variables for build..."
            cp /opt/schooliat/landing/production/shared/.env .env.production
            echo "Building landing page with production dashboard URL..."
            NODE_ENV=production npm run build
            echo "Copying files to web root..."
            cp -r out/* /var/www/schooliat-landing/
            chown -R www-data:www-data /var/www/schooliat-landing
            echo "Reloading Nginx..."
            systemctl reload nginx
            echo "Landing Page deployment complete!"
