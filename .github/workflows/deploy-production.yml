name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:  # Allow manual trigger

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          ref: main
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'
      
      # Deploy Backend Production
      - name: Deploy Backend Production
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: 22
          timeout: 60s
          command_timeout: 15m
          debug: true
          script: |
            set -e
            echo "ğŸš€ Deploying Backend Production..."
            cd /opt/schooliat/repo
            echo "ğŸ“¥ Pulling latest code from main branch..."
            git fetch origin main
            git checkout main
            git reset --hard origin/main
            git clean -fd
            echo "ğŸ“¦ Installing dependencies..."
            cd Backend
            npm ci --production
            echo "ğŸ”§ Generating Prisma client..."
            npm run prisma:generate
            echo "ğŸ’¾ Creating database backup..."
            mkdir -p /opt/schooliat/shared/backups
            pg_dump -U schooliat_user schooliat_production > /opt/schooliat/shared/backups/pre-migration-$(date +%Y%m%d-%H%M%S).sql || echo "âš ï¸ Backup failed, continuing..."
            echo "ğŸ—„ï¸ Running database migrations..."
            export DATABASE_URL="${{ secrets.PRODUCTION_DATABASE_URL }}"
            npm run prisma:migrate:deploy
            echo "ğŸ”„ Restarting PM2 process..."
            pm2 restart schooliat-backend-production --update-env
            echo "âœ… Backend Production deployment complete!"
      
      # Deploy Dashboard Production
      - name: Deploy Dashboard Production
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: 22
          timeout: 60s
          command_timeout: 15m
          debug: true
          script: |
            set -e
            echo "ğŸš€ Deploying Dashboard Production..."
            cd /opt/schooliat/repo
            echo "ğŸ“¥ Ensuring latest code from main branch..."
            git fetch origin main
            git checkout main
            cd dashboard
            echo "ğŸ“¦ Installing dependencies (including devDependencies for build)..."
            npm ci
            echo "ğŸ”§ Loading production environment variables for build..."
            cp /opt/schooliat/dashboard/production/shared/.env .env.production
            echo "ğŸ—ï¸ Building dashboard with production API URL..."
            NODE_ENV=production npm run build
            echo "ğŸ“¤ Copying build to production directory..."
            rm -rf /opt/schooliat/dashboard/production/.next
            cp -r .next /opt/schooliat/dashboard/production/
            cp -r public /opt/schooliat/dashboard/production/ 2>/dev/null || true
            cp package.json /opt/schooliat/dashboard/production/
            echo "ğŸ”„ Restarting PM2 process..."
            pm2 restart schooliat-dashboard-production --update-env
            echo "âœ… Dashboard Production deployment complete!"
      
      # Deploy Landing
      - name: Deploy Landing
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: 22
          timeout: 60s
          command_timeout: 15m
          debug: true
          script: |
            set -e
            echo "ğŸš€ Deploying Landing Page..."
            cd /opt/schooliat/repo
            echo "ğŸ“¥ Ensuring latest code from main branch..."
            git fetch origin main
            git checkout main
            cd landing
            echo "ğŸ“¦ Installing dependencies..."
            npm ci --production
            echo "ğŸ”§ Loading production environment variables for build..."
            cp /opt/schooliat/landing/production/shared/.env .env.production
            echo "ğŸ—ï¸ Building landing page with production dashboard URL..."
            NODE_ENV=production npm run build
            echo "ğŸ“¤ Copying files to web root..."
            cp -r out/* /var/www/schooliat-landing/
            chown -R www-data:www-data /var/www/schooliat-landing
            echo "ğŸ”„ Reloading Nginx..."
            systemctl reload nginx
            echo "âœ… Landing Page deployment complete!"
